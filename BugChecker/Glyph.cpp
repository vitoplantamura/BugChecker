#include "Glyph.h"

#include "Root.h"

//
// This code is from the original BugChecker:
//

static const DWORD32 g_vdw9x16FontTable[] = {
	0x00000000, 0x00000000, 0x00ff003f, 0xc0000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00ff003f, 0xc0000040, 0x40000000, 0x00000003, 0xe0000000,
	0x00000000, 0x00000000, 0x003f1f80, 0x00000000, 0x00ff003f, 0xc3c3c060, 0x60008001, 0x040cc7f6, 0x30002010, 0x08000000, 0x00000000, 0x0040bfc0, 0x0000c040, 0x00ff003f, 0xc0c66050, 0x5020c003,
	0x0e0ccdb3, 0x00007038, 0x08000000, 0x00004000, 0x0052b6cd, 0x8101e0e0, 0x00ff003f, 0xc1442050, 0x4924e007, 0x1f0ccdb1, 0xc000f87c, 0x08040200, 0x000041fc, 0x0040bfdd, 0xc381e1f0, 0x00ff1e30,
	0xcf442050, 0x68f8f81f, 0x358ccdb3, 0x6001acd6, 0x08060600, 0x0120e1fc, 0x0040bfdf, 0xc7c2d3f8, 0x30e73326, 0x59866040, 0x58d8fe7f, 0x040ccdb6, 0x30002010, 0x08030c00, 0x0330e0f8, 0x005eb0df,
	0xcfe7fbf8, 0x78c3212f, 0x5083c040, 0x498cf81f, 0x040cc7b6, 0x30002010, 0x083f9fcc, 0x07f9f0f8, 0x004cb9df, 0xcfe7fbb8, 0x78c3212f, 0x50818041, 0xc8d8e007, 0x040cc1b3, 0x63f9ac10, 0x6b030c0c,
	0x0331f070, 0x0040bfcf, 0x87c2d150, 0x30e73326, 0x5987e3c3, 0xc8f8c003, 0x358001b1, 0xc3f8f810, 0x3e06060c, 0x0123f870, 0x0040bfc7, 0x0380c040, 0x00ff1e30, 0xcf0187c1, 0x89248001, 0x1f0cc1b0,
	0x63f87010, 0x1c04020c, 0x0003f820, 0x003f1f82, 0x0101e0e0, 0x00ff003f, 0xc0018380, 0x38200000, 0x0e0cc1b6, 0x33f82010, 0x0800000f, 0xf0000020, 0x00000000, 0x00000000, 0x00ff003f, 0xc0000000,
	0x78000000, 0x04000003, 0xe001fc00, 0x00000000, 0x00000000, 0xff800000, 0x00000000, 0x00ff003f, 0xc0000000, 0x30000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0xff800000, 0x00000000,
	0x00ff003f, 0xc0000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00ff003f, 0xc0000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00001980, 0x01000000, 0x30000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00181980, 0x010300e0, 0x300c1800, 0x00000000, 0x00007c0c, 0x1f0f80c7, 0xf1f1fc7c, 0x3e000000, 0x000000f8, 0x003c088d, 0x87c491b0, 0x10180c00, 0x00000000, 0x0004c61c,
	0x3198c1c6, 0x03198cc6, 0x63000000, 0x6001818c, 0x003c088d, 0x8d64b1b0, 0x20300600, 0x00000000, 0x000cc63c, 0x2180c3c6, 0x03010cc6, 0x63060300, 0xc000c18c, 0x003c001f, 0xcd6360e0, 0x00300619,
	0x83000000, 0x0018ce0c, 0x0180c6c6, 0x03000cc6, 0x63060301, 0x83f0600c, 0x0018000d, 0x8700c0c0, 0x0030060f, 0x03000000, 0x0030de0c, 0x03078cc7, 0xe3f0187c, 0x63000003, 0x00003018, 0x0018000d,
	0x838181d8, 0x0030063f, 0xcfc007f0, 0x0060f60c, 0x0600ccc0, 0x331818c6, 0x3f000006, 0x00001830, 0x0018001f, 0xc1c36370, 0x0030060f, 0x03000000, 0x00c0e60c, 0x0c00cfe0, 0x331830c6, 0x03000003,
	0x03f03030, 0x0000000d, 0x8d669330, 0x00300619, 0x83000000, 0x0180c60c, 0x1800c0c0, 0x331830c6, 0x03060301, 0x80006000, 0x0018000d, 0x8d649330, 0x00180c00, 0x00030000, 0xc100c60c, 0x3018c0c6,
	0x331860c6, 0x63060300, 0xc000c030, 0x00180000, 0x07c061d8, 0x000c1800, 0x00030000, 0xc0007c3f, 0x3f8f81e3, 0xe1f0607c, 0x3e000100, 0x60018030, 0x00000000, 0x01000000, 0x00000000, 0x00010000,
	0x00000000, 0x00000000, 0x00000000, 0x00000200, 0x00000000, 0x00000000, 0x01000000, 0x00000000, 0x00020000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00004000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x0000e000, 0x001c3f0f, 0x8fc7f3f8, 0xf8c61e07, 0x9ccf040a, 0x18f8fc3e, 0x3f0f8ff6, 0x330d86c3, 0x61bfc780, 0x01e1b000, 0x3c361998, 0xc6633199, 0x8cc60c03, 0x0cc6061b, 0x198c6663,
	0x1998cdb6, 0x330d86c3, 0x61b0c608, 0x00631800, 0x42631998, 0xc6631189, 0x8cc60c03, 0x0cc6073b, 0x998c6663, 0x19984996, 0x330d8666, 0x61a0c60c, 0x00600000, 0x9d631998, 0x066341a1, 0x80c60c03,
	0x0cc607fb, 0xd98c6663, 0x198c0186, 0x330d863c, 0x33018606, 0x00600000, 0xa5631f18, 0x0663c1e1, 0x80fe0c03, 0x0f8607fb, 0xf98c6663, 0x19870186, 0x330d8618, 0x1e030603, 0x00600000, 0xa57f1998,
	0x0663c1e1, 0x9cc60c03, 0x0f0606db, 0x798c7c63, 0x1f018186, 0x330d8618, 0x0c060601, 0x80600000, 0xad631998, 0x066341a1, 0x8cc60c33, 0x0d86061b, 0x398c6063, 0x1b00c186, 0x330db63c, 0x0c0c0600,
	0xc0600000, 0xb6631998, 0xc6631181, 0x8cc60c33, 0x0cc6261b, 0x198c606b, 0x1b18c186, 0x3199fe66, 0x0c184600, 0x60600000, 0x40631998, 0xc6633181, 0x8cc60c33, 0x0cc6661b, 0x198c606f, 0x1998c186,
	0x30f1cec3, 0x0c38c600, 0x20600000, 0x3c633f0f, 0x8fc7f3c0, 0xfcc61e1e, 0x1ccfe61b, 0x18f8f03e, 0x398f83c3, 0xe06186c3, 0x1e3fc780, 0x01e00000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000003, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x000001fe, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x18000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x18003800, 0x01c00070, 0x00e00c03, 0x1c038000, 0x00000000, 0x00000100, 0x00000000, 0x000001c1, 0x8381d800, 0x10001800, 0x00c000d8, 0x00600c03, 0x0c018000, 0x00000000,
	0x00000300, 0x00000000, 0x00000301, 0x80c37000, 0x08001800, 0x00c000c0, 0x00600000, 0x0c018000, 0x00000000, 0x00000300, 0x00000000, 0x00000301, 0x80c00020, 0x003c1f0f, 0x87c3e1e0, 0xec6c1c07,
	0x0cc1861b, 0x70f8dc3e, 0x378f8fc6, 0x630d86c3, 0x633f8301, 0x80c00070, 0x00061998, 0xccc630c1, 0x98760c03, 0x0d818739, 0x998c6666, 0x1d98c306, 0x630d8666, 0x63230e00, 0x007000d8, 0x003e1998,
	0x0cc630c1, 0x98660c03, 0x0f0187f9, 0x998c6666, 0x180c0306, 0x630d863c, 0x63060300, 0x00c0018c, 0x00661998, 0x0cc7f0c1, 0x98660c03, 0x0f0186d9, 0x998c6666, 0x18070306, 0x630db618, 0x630c0301,
	0x80c0018c, 0x00661998, 0x0cc600c1, 0x98660c03, 0x0d818619, 0x998c6666, 0x18018306, 0x6199fe3c, 0x63180301, 0x80c0018c, 0x00661998, 0xccc630c1, 0x98660c03, 0x0cc18619, 0x998c6666, 0x1818c346,
	0x60f1ce66, 0x36308301, 0x80c001fc, 0x003b1f0f, 0x8763e1e0, 0xf8e61e03, 0x1cc3c619, 0x98f87c3e, 0x3c0f8183, 0xb06186c3, 0x1c3f81c1, 0x83800000, 0x00000000, 0x00000000, 0x18000033, 0x00000000,
	0x00006006, 0x00000000, 0x00000000, 0x18000000, 0x00000000, 0x00000000, 0x00000001, 0x98000033, 0x00000000, 0x00006006, 0x00000000, 0x00000000, 0x30000000, 0x00000000, 0x00000000, 0x00000000,
	0xf000001e, 0x00000000, 0x0000f00f, 0x00000000, 0x00000000, 0x60000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000003, 0x18700600, 0x00000000, 0x00000000, 0x63318000, 0x00000000, 0x00000186, 0x000600c0, 0x00180030, 0x00018603, 0x18880c00, 0x00030006, 0x00c18000,
	0x63318000, 0x00000000, 0x7c66030f, 0x0cc30120, 0x003c6318, 0x0cc3c300, 0x00701000, 0x0f878c63, 0x01e0c0c6, 0x00000003, 0x861be01c, 0xc6660419, 0x8cc080c0, 0x00666304, 0x0cc66080, 0xe070fe00,
	0x1a8ccc60, 0x833020c6, 0x3e318306, 0xc3333036, 0xc6000000, 0x00000000, 0x00000000, 0x00000001, 0xb0d86600, 0x32000000, 0x00000000, 0x63318306, 0x01e33030, 0xc0661f0f, 0x0783c1e0, 0xf87c3e1f,
	0x070381c3, 0x198c6200, 0x320f87c3, 0xe33198c6, 0x63318fcf, 0x00c33030, 0xc0663181, 0x80c06031, 0x8cc66331, 0x830180c3, 0x198c683f, 0x3318cc66, 0x333198c6, 0x63319866, 0x00c3e0fc, 0xc066318f,
	0x87c3e1f1, 0x80c66331, 0x830180c3, 0xf9fc780d, 0xbf18cc66, 0x333198c6, 0x63319806, 0x03f31830, 0xc0663f99, 0x8cc66331, 0x80fe7f3f, 0x830180c3, 0x198c683f, 0xb218cc66, 0x333198c6, 0x63319806,
	0x00c31830, 0xc6663019, 0x8cc66331, 0x80c06030, 0x030180c3, 0x198c626c, 0x3218cc66, 0x333198c6, 0x63319866, 0x03f33c30, 0xc6663199, 0x8cc66331, 0x8cc66331, 0x830180c3, 0x198c666c, 0x3298cc66,
	0x3331986c, 0x63318fcf, 0x20c31830, 0x7c3b1f0e, 0xc763b1d8, 0xf87c3e1f, 0x0783c1e3, 0x198cfe3f, 0x338f87c3, 0xe1d8ec38, 0x3e1f030d, 0xc0c31830, 0x10000000, 0x00000000, 0x20000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000030, 0x00000300, 0x00001c30, 0x08000000, 0x00000000, 0x10000000, 0x00000000, 0x00000000, 0x00000000, 0x00000060, 0x00000000, 0x000001b0, 0x70000000, 0x00000000,
	0xe0000000, 0x00000000, 0x00000000, 0x00000000, 0x000000c0, 0x00000000, 0x000000e0, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x0003b000, 0x00000000, 0x00000000, 0x00000055, 0x3fc30180, 0xc0d80000, 0x1b0d8003, 0x61b06000, 0x06030180, 0xc006e1c0, 0x00000000, 0x00000000, 0x0000552a, 0x95430180, 0xc0d80000,
	0x1b0d8003, 0x61b06000, 0x0c060301, 0x87600060, 0xf0300000, 0x0c060180, 0x00000055, 0x3fc30180, 0xc0d80000, 0x1b0d8003, 0x61b06000, 0x10080402, 0x0dc431e1, 0x98300000, 0x1c0e0180, 0x0000552a,
	0x95430180, 0xc0d80000, 0x1b0d8003, 0x61b06000, 0x00000000, 0x00063361, 0x98000000, 0x0c864000, 0x00000055, 0x3fc30180, 0xc0d80000, 0x1b0d8003, 0x61b06000, 0x781c1f19, 0x8dc731b0, 0xf0300000,
	0x0d068180, 0xd9b0552a, 0x95430180, 0xc0d80000, 0x1b0d8003, 0x61b06000, 0x0c0c3199, 0x8667b000, 0x00300000, 0x0e070181, 0xb0d80055, 0x3fc30187, 0xc0d800f8, 0x7b0d9fcf, 0x61b3e000, 0x7c0c3199,
	0x8667f3f1, 0xf8607f3f, 0x84023183, 0x606c552a, 0x95430180, 0xc0d80018, 0x030d80c0, 0x61b06000, 0xcc0c3199, 0x8666f000, 0x00c06001, 0x8bc5b3c1, 0xb0d80055, 0x3fc30f87, 0xc3d9fcf8, 0x7b0d9ecf,
	0xe7f3e1f0, 0xcc0c3199, 0x86667000, 0x00c66001, 0x9069b3c0, 0xd9b0552a, 0x95430180, 0xc0d86c18, 0x1b0d86c0, 0x00000030, 0xcc0c3199, 0x86663000, 0x00c66001, 0x80c1f3c0, 0x00000055, 0x3fc30180,
	0xc0d86c18, 0x1b0d86c0, 0x00000030, 0x761e1f0e, 0xc6663000, 0x007c6001, 0x81803180, 0x0000552a, 0x95430180, 0xc0d86c18, 0x1b0d86c0, 0x00000030, 0x00000000, 0x00000000, 0x00000000, 0x03e03000,
	0x00000055, 0x3fc30180, 0xc0d86c18, 0x1b0d86c0, 0x00000030, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x0000552a, 0x95430180, 0xc0d86c18, 0x1b0d86c0, 0x00000030, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000055, 0x3fc30180, 0xc0d86c18, 0x1b0d86c0, 0x00000030, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x0000552a, 0x95430180, 0xc0d86c18, 0x1b0d86c0, 0x00000030,
	0x180c0003, 0x0000c060, 0x6c36000d, 0x80036000, 0xd8303600, 0x0006c180, 0x00006c18, 0x0c001ff0, 0x07803fff, 0x180c0003, 0x0000c060, 0x6c36000d, 0x80036000, 0xd8303600, 0x0006c180, 0x00006c18,
	0x0c001ff0, 0x07803fff, 0x180c0003, 0x0000c060, 0x6c36000d, 0x80036000, 0xd8303600, 0x0006c180, 0x00006c18, 0x0c001ff0, 0x07803fff, 0x180c0003, 0x0000c060, 0x6c36000d, 0x80036000, 0xd8303600,
	0x0006c180, 0x00006c18, 0x0c001ff0, 0x07803fff, 0x180c0003, 0x0000c060, 0x6c36000d, 0x80036000, 0xd8303600, 0x0006c180, 0x00006c18, 0x0c001ff0, 0x07803fff, 0x180c0003, 0x0000c060, 0x6c36000d,
	0x80036000, 0xd8303600, 0x0006c180, 0x00006c18, 0x0c001ff0, 0x07803fff, 0x180c0003, 0x0000c07e, 0x6c379ffd, 0xfff37fff, 0xdfff367f, 0xc006c1f8, 0xfc006cff, 0x8c001ff0, 0x07803fff, 0x180c0003,
	0x0000c060, 0x6c301800, 0x00030000, 0x00003600, 0x0006c180, 0xc0006c18, 0x0c001ff0, 0x07803fff, 0x1fffffe3, 0xfffffc7e, 0x6f3f9bff, 0xfef37fff, 0xdfffffff, 0xffe7f1f8, 0xfcffffff, 0xfc07ffff,
	0xff803e00, 0x00000603, 0x0000c060, 0x6c001b00, 0x06c36000, 0xd800000c, 0x0d800000, 0xc0d86c18, 0x00061fff, 0xff803e00, 0x00000603, 0x0000c060, 0x6c001b00, 0x06c36000, 0xd800000c, 0x0d800000,
	0xc0d86c18, 0x00061fff, 0xff803e00, 0x00000603, 0x0000c060, 0x6c001b00, 0x06c36000, 0xd800000c, 0x0d800000, 0xc0d86c18, 0x00061fff, 0xff803e00, 0x00000603, 0x0000c060, 0x6c001b00, 0x06c36000,
	0xd800000c, 0x0d800000, 0xc0d86c18, 0x00061fff, 0xff803e00, 0x00000603, 0x0000c060, 0x6c001b00, 0x06c36000, 0xd800000c, 0x0d800000, 0xc0d86c18, 0x00061fff, 0xff803e00, 0x00000603, 0x0000c060,
	0x6c001b00, 0x06c36000, 0xd800000c, 0x0d800000, 0xc0d86c18, 0x00061fff, 0xff803e00, 0x00000603, 0x0000c060, 0x6c001b00, 0x06c36000, 0xd800000c, 0x0d800000, 0xc0d86c18, 0x00061fff, 0xff803e00,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0xc0000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0xc0000038,
	0x000001ed, 0x83800000, 0x003c3f80, 0x0fe00000, 0x0038001f, 0x07800000, 0x00000000, 0x000000e0, 0xc000006c, 0x00000186, 0xc4c00000, 0x00661880, 0x0c200000, 0x00103e31, 0x8c400010, 0x00f80000,
	0x0c0181b0, 0xc000006c, 0x00000186, 0xc0c00000, 0x00661800, 0x46000000, 0x007c6331, 0x86000030, 0x018cfe0c, 0x060301b0, 0xc0600038, 0x00000186, 0xc1800000, 0x746c180f, 0xc303f330, 0xfcd66331,
	0x8306e3e0, 0xf18c000c, 0x03060180, 0xc060ec00, 0x00000186, 0xc301f800, 0xdc66181d, 0x81868331, 0xb0d66331, 0x8f8db671, 0x818c003f, 0x018c0180, 0xc001b800, 0x00000186, 0xc7c1f800, 0xc863180d,
	0x83064330, 0x30d67f31, 0x998db6f3, 0x018cfe0c, 0x03060180, 0xc1f80000, 0x18001d80, 0x0001f800, 0xc863180d, 0x86064330, 0x30d6631b, 0x198db6b3, 0xe18c000c, 0x06030186, 0xc000ec00, 0x180c0d80,
	0x0001f800, 0xc863180d, 0x8c064330, 0x307c630a, 0x198767b3, 0x018c0000, 0x0c018186, 0xc061b800, 0x00000d80, 0x0001f800, 0xdc6e180d, 0x8c264330, 0x3010630a, 0x19800731, 0x818cfe00, 0x00000186,
	0xc0600000, 0x00000780, 0x0001f800, 0x76603c09, 0x0fe383e0, 0x20383e3b, 0x8f0003e0, 0xf18c007f, 0x9f8fc183, 0x80000000, 0x00000380, 0x00000000, 0x00200000, 0x00000200, 0x00000000, 0x00000600,
	0x00000000, 0x00000180, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000200, 0x00000000, 0x00000400, 0x00000000, 0x00000180, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000180, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000180, 0x00000000, 0x00000000, 0x00000000
};

static const DWORD32 g_vdwColorTable00RRGGBB[] =
{
	0x00000000,
	0x00000080,
	0x00008000,
	0x00008080,
	0x00800000,
	0x00800080,
	0x00808000,
	0x00c0c0c0,
	0x00808080,
	0x000000ff,
	0x0000ff00,
	0x0000ffff,
	0x00ff0000,
	0x00ff00ff,
	0x00ffff00,
	0x00ffffff
};

//

void Glyph::DrawStr(IN const CHAR* pcStr, IN BYTE bTextColor, IN ULONG ulX, IN ULONG ulY, IN PVOID pvPrimary)
{
	if (!pvPrimary || (_6432_(ULONG64, ULONG32))pvPrimary == 0x1)
		return;

	for (int i = 0; i < ::strlen(pcStr); i++, ulX++)
		Glyph::Draw(pcStr[i], bTextColor, ulX, ulY, pvPrimary);
}

void Glyph::Draw(IN BYTE bTextChar, IN BYTE bTextColor, IN ULONG ulX, IN ULONG ulY, IN PVOID pvPrimary, ULONG ulTargetStartX /*= 0*/, ULONG ulTargetStartY /*= 0*/, BOOLEAN hasCursor /*= FALSE*/)
{
	const ULONG ulFontTableWidthInBits = 9 * 32;
	const ULONG ulGlyphWidthInBits = Root::I->GlyphWidth;
	const ULONG ulGlyphHeightInBits = Root::I->GlyphHeight;
	const ULONG ulFontTableStrideInBits = 9 * 32;
	const LONG lDisplayPitch = Root::I->fbStride; // 1152 * 4;
	const DWORD32 dwRGBBitCount = 32;

	//

	ULONG ulFontTableChrWidth, ulChrX, ulChrY, ulBitX, ulBitY, ulBitStart;
	DWORD32* pdwDwordStart;
	ULONG ulDwordBitStart;

	ulFontTableChrWidth = ulFontTableWidthInBits / ulGlyphWidthInBits;

	ulChrY = ((ULONG)bTextChar) / ulFontTableChrWidth;
	ulChrX = ((ULONG)bTextChar) - (ulChrY * ulFontTableChrWidth);

	ulBitX = ulChrX * ulGlyphWidthInBits;
	ulBitY = ulChrY * ulGlyphHeightInBits;

	ulBitStart = ulBitY * ulFontTableStrideInBits + ulBitX;

	pdwDwordStart = (DWORD32*)g_vdw9x16FontTable + ulBitStart / 32;
	ulDwordBitStart = 31 - (ulBitStart % 32);

	//

	ULONG ulVideoX, ulVideoY;
	BYTE* pbDisplayStart;

	ulVideoX = ulTargetStartX + ulX * ulGlyphWidthInBits;
	ulVideoY = ulTargetStartY + ulY * ulGlyphHeightInBits;

	pbDisplayStart = (BYTE*)pvPrimary +
		ulVideoY * lDisplayPitch +
		ulVideoX * (dwRGBBitCount / 8);

	//

	ULONG ulFinalFrameBufStrideInDwords;
	DWORD32 dwFore, dwBack;
	BYTE bForeColor, bBackColor;
	DWORD32* pdwDwordPtrFB;
	DWORD32* pdwDwordPtr;
	ULONG ulI;
	ULONG ulW;
	DWORD32* pdwDwordPtrLine;
	DWORD32 dwDword;
	ULONG ulDwordBit;
	ULONG ulFinalFontTblStrideInDwords;

	// Initialize the variables.

	ulFinalFontTblStrideInDwords =
		ulFontTableStrideInBits / 32;

	ulFinalFrameBufStrideInDwords =
		lDisplayPitch / 4 - ulGlyphWidthInBits;

	bForeColor = bTextColor & 0xF;
	bBackColor = bTextColor >> 4;

	dwFore = g_vdwColorTable00RRGGBB[bForeColor];
	dwBack = g_vdwColorTable00RRGGBB[bBackColor];

	if (hasCursor)
	{
		dwFore ^= g_vdwColorTable00RRGGBB[7];
		dwBack ^= g_vdwColorTable00RRGGBB[7];
	}

	pdwDwordPtrFB = (DWORD32*)pbDisplayStart;
	pdwDwordPtr = pdwDwordStart;

	// Draw in the Framebuffer.

	for (ulI = 0; ulI < ulGlyphHeightInBits; ulI++)
	{
		ulW = ulGlyphWidthInBits;
		pdwDwordPtrLine = pdwDwordPtr;

		dwDword = *pdwDwordPtr;
		ulDwordBit = ulDwordBitStart;

		do
		{
			if (ulDwordBit == 0xFFFFFFFF)
			{
				dwDword = *++pdwDwordPtrLine;
				ulDwordBit = 31;
			}

			if ((dwDword >> ulDwordBit) & 1)
				*pdwDwordPtrFB++ = dwFore;
			else
				*pdwDwordPtrFB++ = dwBack;

			ulDwordBit--;

		} while (--ulW);

		pdwDwordPtrFB += ulFinalFrameBufStrideInDwords;
		pdwDwordPtr += ulFinalFontTblStrideInDwords;
	}
}

// Ref: https://github.com/freedesktop/xorg-xf86-video-vmware/

#ifndef _AMD64_

static VOID
__outdword(
	__in USHORT Port,
	__in ULONG Data
)
{
	__asm
	{
		push	eax
		push	edx

		mov		dx, Port
		mov		eax, Data

		out		dx, eax

		pop		edx
		pop		eax
	}
}

static ULONG
__indword(
	__in USHORT Port
)
{
	ULONG retVal;

	__asm
	{
		push	eax
		push	edx

		mov		dx, Port

		in		eax, dx

		mov		retVal, eax

		pop		edx
		pop		eax
	}

	return retVal;
}

#endif

const static ULONG SVGA_FIFO_MIN = 0;
const static ULONG SVGA_FIFO_MAX = 1;
const static ULONG SVGA_FIFO_NEXT_CMD = 2;
const static ULONG SVGA_FIFO_STOP = 3;

const static ULONG SVGA_INDEX_PORT = 0x0;
const static ULONG SVGA_VALUE_PORT = 0x1;

const static ULONG SVGA_REG_SYNC = 21;
const static ULONG SVGA_REG_BUSY = 22;
const static ULONG SVGA_REG_WIDTH = 2;
const static ULONG SVGA_REG_HEIGHT = 3;

const static ULONG SVGA_CMD_UPDATE = 1;

VOID Glyph::UpdateScreen(ULONG x, ULONG y, ULONG w, ULONG h) // WARNING: caller of this function must have interrupts disabled.
{
	if (!Root::I->VmFifo || !Root::I->VmIoPort)
		return;

	volatile DWORD* fifo = Root::I->VmFifo;
	ULONG port = Root::I->VmIoPort;

	auto fifoWrite = [&](DWORD dw) {

		fifo[fifo[SVGA_FIFO_NEXT_CMD] / 4] = dw;

		if (fifo[SVGA_FIFO_NEXT_CMD] == fifo[SVGA_FIFO_MAX] - 4)
			fifo[SVGA_FIFO_NEXT_CMD] = fifo[SVGA_FIFO_MIN];
		else
			fifo[SVGA_FIFO_NEXT_CMD] += 4;
	};

	// try to avoid race conditions with the Guest's virtual device driver.

	DWORD prevNext = fifo[SVGA_FIFO_NEXT_CMD];
	DWORD prevStop = fifo[SVGA_FIFO_STOP];

	fifo[SVGA_FIFO_STOP] = fifo[SVGA_FIFO_NEXT_CMD];

	// write our command in the FIFO buffer.

	fifoWrite(SVGA_CMD_UPDATE);
	fifoWrite(x);
	fifoWrite(y);
	fifoWrite(w);
	fifoWrite(h);

	// process our command immediately. The hypervisor will update SVGA_FIFO_STOP.

	::__outdword(port + SVGA_INDEX_PORT, SVGA_REG_SYNC); // x86 OUT is our memory barrier.
	::__outdword(port + SVGA_VALUE_PORT, 1);

	do
	{
		::__outdword(port + SVGA_INDEX_PORT, SVGA_REG_BUSY);

	} while (::__indword(port + SVGA_VALUE_PORT));

	// restore the state of the FIFO buffer.

	fifo[SVGA_FIFO_NEXT_CMD] = prevNext;
	fifo[SVGA_FIFO_STOP] = prevStop;
}

eastl::pair<ULONG, ULONG> Glyph::GetScreenDim()
{
	if (!Root::I->VmFifo || !Root::I->VmIoPort)
		return eastl::pair<ULONG, ULONG>(0, 0);

	ULONG port = Root::I->VmIoPort;

	::__outdword(port + SVGA_INDEX_PORT, SVGA_REG_WIDTH);
	ULONG w = ::__indword(port + SVGA_VALUE_PORT);

	::__outdword(port + SVGA_INDEX_PORT, SVGA_REG_HEIGHT);
	ULONG h = ::__indword(port + SVGA_VALUE_PORT);

	return eastl::pair<ULONG, ULONG>(w, h);
}
